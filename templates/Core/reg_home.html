{% extends 'base.html' %}
{% load static %}
{% block content %}
<body>
<div class="container mt-5">
    <h1 class="text-center mb-5"> Plant Home </h1>
    <div class="row row-cols-1 row-cols-md-3 g-4">
        {% if data %}
            {% for plant in plants %}
                <div class="col">
                    <div class="card h-100">
                        <div class="card-header"><h2 class="card-title">{{plant.name}}</h2></div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="myChart{{plant.id}}"></canvas>
                            </div>

                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal{{plant.id}}">More Info</button>
                        </div>
                    </div>
                </div>

                <!-- Modal Dialog for Each Plant -->
                <div class="modal fade" id="exampleModal{{plant.id}}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLabel">{{plant.name}}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                           <div class="modal-body">
    <p>EC: {{plant.ec}}</p>
    <p>pH: {{plant.ph}}</p>
    <p>NPK: {{plant.npk}}</p>
    <p>Temperature: {{plant.temperature}}</p>
    <p>Ideal Moisture: {{plant.ideal_moisture}}</p>
    <p>Fertilizer: {{plant.fertilizer}}</p>
    <div class="row">
        <div class="col-lg-3">
            <div class="chart-container">
                <canvas id="detailChartTemp{{plant.id}}"></canvas>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="chart-container">
                <canvas id="detailChartEC{{plant.id}}"></canvas>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="chart-container">
                <canvas id="detailChartNPK{{plant.id}}"></canvas>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="chart-container">
                <canvas id="detailChartPH{{plant.id}}"></canvas>
            </div>
        </div>
    </div>
</div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    </div>
</div>

<script>
    var data = JSON.parse('{{ data | safe }}');
    var detail_data = JSON.parse('{{ detail_data | safe }}');

    var charts = {};
    // Converts a timestamp to hours
function toHours(timestamp) {
    var date = new Date(timestamp);
    var hours = date.getHours();
    var remaining_hours = 23 - hours;
    var remaining_minutes = 60 - date.getMinutes();
    if (remaining_minutes === 60){
    remaining_hours += 1;
     remaining_minutes = 0;}
    var formattedTime = '-' + remaining_hours + ':' + remaining_minutes;
    return formattedTime;
}
// Converts a timestamp to day
function getDay(timestamp) {
    var date = new Date(timestamp);
    var day = date.getDate();  // Returns the day of the month
    var month = date.getMonth() + 1;  // Returns the month (0 is January, so we must add 1)
    var year = date.getFullYear();  // Returns the year
    return `${year}-${month < 10 ? '0' + month : month}-${day < 10 ? '0' + day : day}`;
}
    function drawChart(canvasId, plantName, label, data_x,dataset) {
        var lastTimeStamp = data_x[data_x.length - 1];
        var dayOfLastEntry = getDay(lastTimeStamp);
        var ctx = document.getElementById(canvasId).getContext('2d');
        if(charts[canvasId]) {  // If chart exists for the given canvasId, destroy it
            charts[canvasId].destroy();
        }
        charts[canvasId] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data_x.map(toHours), // x-values (timestamps)
                datasets: [{
                    label: `${label} (${dayOfLastEntry})`,
                    data: dataset, // y-values (moisture)
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // For Each Plant
    {% for plant in plants %}
    console.log(data['{{ plant.name }}'].m_moist);
        // For Home Page Chart
        drawChart('myChart{{plant.id}}', '{{plant.name}}', 'Moisture',data['{{ plant.name }}'].date_time, data['{{ plant.name }}'].m_moist);

        // Modal 'show' Event
        var myModalEl = document.getElementById('exampleModal{{plant.id}}');
        myModalEl.addEventListener('show.bs.modal', function (e) {
            // For Detailed Info Page Charts
            drawChart('detailChartTemp{{plant.id}}', '{{plant.name}}', 'Temperature',detail_data['{{ plant.name }}'].date_time, detail_data['{{ plant.name }}'].m_temp);
            drawChart('detailChartEC{{plant.id}}', '{{plant.name}}', 'EC', detail_data['{{ plant.name }}'].date_time,detail_data['{{ plant.name }}'].m_ec);
            drawChart('detailChartNPK{{plant.id}}', '{{plant.name}}', 'NPK', detail_data['{{ plant.name }}'].date_time,detail_data['{{ plant.name }}'].m_npk);
            drawChart('detailChartPH{{plant.id}}', '{{plant.name}}', 'pH', detail_data['{{ plant.name }}'].date_time,detail_data['{{ plant.name }}'].m_ph);
        });
    {% endfor %}
</script>
{% endblock %}
